# 用户故事 1-4：找回密码

## 故事描述

作为一名忘记密码的用户，我希望能够通过找回密码功能，重置我的登录密码，继续访问系统。

## 验收标准

- 用户可以通过用户名发起找回密码请求
- 系统通过安全方式验证用户身份
- 用户可以通过验证码或安全问题重置密码
- 找回密码过程安全，防止信息泄露

## 业务价值

- 降低因忘记密码导致的用户流失
- 提升用户自助服务能力
- 减少客服支持成本

---

## 技术实现建议（Tech Lead）

- 前端：找回密码表单，输入用户名，友好提示
- 后端：生成一次性验证码，使用安全问题验证，验证码需有时效性
- 安全：验证码加密存储，防止暴力破解

## 技术难点

- 验证码的安全性与时效性
- 防止信息泄露和暴力破解
- 用户身份验证的准确性

## 测试建议

- 单元测试：验证码生成与校验
- 集成测试：找回密码流程基本功能测试
- 安全测试：暴力破解防护测试

---

## 详细实现步骤

### 前端实现步骤

1. **找回密码页面**
   - 创建 `app/auth/forgot-password/page.tsx`
   - 设计简洁的找回密码表单
   - 添加用户名输入字段

2. **表单验证**
   - 使用 React Hook Form 进行表单验证
   - 验证用户名格式
   - 实现实时验证反馈

3. **提交处理**
   - 创建 `lib/auth.ts` 中的找回密码 API 调用
   - 处理提交状态和错误信息
   - 显示友好的成功/失败提示

4. **验证码输入页面**
   - 创建 `app/auth/verify-code/page.tsx`
   - 通过 URL 参数获取用户标识
   - 实现验证码输入表单

5. **重置密码页面**
   - 创建 `app/auth/reset-password/page.tsx`
   - 通过验证码验证用户身份
   - 实现新密码和确认密码表单

6. **密码重置表单**
   - 验证新密码强度
   - 确认密码一致性检查
   - 显示密码强度指示器

7. **用户体验优化**
   - 添加加载状态指示器
   - 实现友好的错误提示
   - 成功重置后的跳转逻辑

### 后端实现步骤

1. **找回密码 API**
   - 创建 `app/api/auth/forgot-password/route.ts`
   - 验证用户名是否存在
   - 生成安全的验证码

2. **验证码生成**
   - 使用加密算法生成唯一验证码
   - 设置验证码过期时间（通常 10-30 分钟）
   - 将验证码与用户关联存储

3. **验证码验证 API**
   - 创建 `app/api/auth/verify-code/route.ts`
   - 验证验证码的有效性
   - 返回验证结果

4. **重置密码 API**
   - 创建 `app/api/auth/reset-password/route.ts`
   - 验证验证码的有效性
   - 更新用户密码

5. **安全措施**
   - 实现验证码使用次数限制（一次性使用）
   - 添加 IP 地址限制
   - 防止暴力破解攻击

### 数据库设计（Prisma Schema）

1. **密码重置表**
   ```prisma
   model PasswordReset {
     id        String   @id @default(cuid())
     userId    String
     code      String   @unique
     expiresAt DateTime
     usedAt    DateTime?
     createdAt DateTime @default(now())
     ipAddress String?
     
     @@map("password_resets")
   }
   ```

2. **用户安全问题表（可选）**
   ```prisma
   model SecurityQuestion {
     id       String @id @default(cuid())
     userId   String
     question String
     answer   String // 加密存储
     
     @@map("security_questions")
   }
   ```

### 安全实现

1. **验证码安全**
   - 使用加密算法生成验证码
   - 实现验证码哈希存储
   - 设置合理的过期时间

2. **防暴力破解**
   - 限制找回密码请求频率
   - 实现 IP 地址限制
   - 添加验证码验证

3. **信息泄露防护**
   - 不泄露用户是否存在的信息
   - 统一成功/失败响应格式
   - 记录安全事件日志

4. **验证码存储**
   - 使用 Redis 存储验证码（高性能）
   - 实现验证码自动过期
   - 防止验证码泄露

### 配置管理

1. **环境变量配置**
   ```env
   # 验证码配置
   VERIFICATION_CODE_LENGTH=6
   VERIFICATION_CODE_EXPIRY=1800 # 30分钟
   MAX_VERIFICATION_ATTEMPTS=3
   
   # 安全配置
   MAX_FORGOT_PASSWORD_ATTEMPTS=5
   FORGOT_PASSWORD_RATE_LIMIT=300 # 5分钟
   
   # Redis 配置
   REDIS_URL=your-redis-url
   ```

2. **验证码策略配置**
   - 配置验证码长度和复杂度
   - 设置验证码过期时间
   - 配置重试次数限制

### 基本测试步骤

1. **API 测试**
   - 测试找回密码请求
   - 测试验证码验证流程
   - 测试验证码过期处理
   - 测试重复使用验证码

2. **验证码测试**
   - 测试验证码生成功能
   - 测试验证码验证逻辑
   - 测试验证码过期机制
   - 测试验证码安全性

3. **安全测试**
   - 测试暴力破解防护
   - 测试验证码安全性
   - 测试信息泄露防护
   - 测试 XSS 和 CSRF 防护

### 监控和日志

1. **找回密码监控**
   - 监控找回密码请求频率
   - 监控验证码验证成功率
   - 监控密码重置成功率

2. **安全事件监控**
   - 监控异常找回密码请求
   - 监控暴力破解尝试
   - 监控验证码使用情况

3. **用户行为分析**
   - 分析找回密码使用频率
   - 分析密码重置成功率
   - 分析用户流失原因

### 性能优化

1. **验证码生成优化**
   - 使用高效的加密算法
   - 实现验证码缓存机制
   - 优化验证码查询性能

2. **数据库优化**
   - 使用索引优化查询
   - 实现数据清理策略
   - 优化存储空间使用

