# 用户故事 1-3：用户登出

## 故事描述

作为一名已登录用户，我希望能够随时安全地退出系统，保护我的账户信息不被他人使用。

## 验收标准

- 用户可以在任意页面安全登出
- 登出后，用户会被重定向到登录页或首页
- 登出后，用户的会话和敏感信息被清除
- 支持多设备同时登出（可选）

## 业务价值

- 提升系统安全性，防止账号被滥用
- 满足用户的隐私和安全需求
- 建立安全的会话管理机制

---

## 技术实现建议（Tech Lead）

- 前端：在用户界面提供明显的登出按钮，调用登出 API
- 后端：使用 Supabase Auth 销毁会话，清理相关缓存
- 安全：登出后清除本地所有敏感信息，实现 JWT 黑名单

## 技术难点

- JWT token 的失效处理（黑名单机制）
- 多设备会话同步
- 敏感数据的彻底清理

## 测试建议

- 单元测试：登出 API、状态清理
- 集成测试：登出流程基本功能测试
- 安全测试：会话清理验证测试

---

## 详细实现步骤

### 前端实现步骤

1. **登出按钮组件**
   - 在导航栏或用户菜单中添加登出按钮
   - 创建 `components/common/logout-button.tsx`
   - 实现确认对话框（可选）

2. **登出逻辑实现**
   - 创建 `lib/auth.ts` 中的登出 API 调用
   - 使用 Supabase Auth 进行登出
   - 清除本地存储的认证信息：
     - localStorage 中的 token
     - sessionStorage 中的用户数据
     - cookies 中的认证信息

3. **状态清理**
   - 清除认证上下文中的用户状态
   - 重置 Supabase Auth 状态
   - 清除路由缓存（如果有）

4. **路由重定向**
   - 登出后重定向到登录页或首页
   - 使用 Next.js router 实现页面跳转
   - 实现平滑的页面跳转

5. **用户体验优化**
   - 显示登出成功提示
   - 添加加载状态指示器
   - 防止重复点击登出按钮

6. **安全清理**
   - 清除所有敏感数据
   - 清除表单缓存
   - 清除浏览器历史记录（可选）

### 后端实现步骤

1. **登出 API 端点**
   - 创建 `app/api/auth/logout/route.ts`
   - 使用 Supabase Auth 进行登出
   - 处理登出请求和响应

2. **JWT Token 失效**
   - 实现 JWT 黑名单机制
   - 将失效的 token 加入黑名单
   - 使用 Redis 存储黑名单（推荐）

3. **会话清理**
   - 使用 Supabase Auth 清理用户会话
   - 清除服务器端会话数据
   - 更新用户登录状态

4. **缓存清理**
   - 清除用户相关的缓存数据
   - 清除权限缓存
   - 清除用户会话缓存

5. **审计日志**
   - 记录用户登出事件
   - 记录登出时间和 IP 地址
   - 保存登出日志用于安全审计

### 数据库设计（Prisma Schema）

1. **JWT 黑名单表**
   ```prisma
   model JwtBlacklist {
     id        String   @id @default(cuid())
     tokenHash String   @unique
     userId    String
     expiresAt DateTime
     createdAt DateTime @default(now())
     
     @@map("jwt_blacklist")
   }
   ```

2. **用户活动日志表**
   ```prisma
   model UserActivityLog {
     id           String   @id @default(cuid())
     userId       String
     activityType String   // 'login', 'logout', 'password_change'
     ipAddress    String?
     userAgent    String?
     createdAt    DateTime @default(now())
     
     @@map("user_activity_logs")
   }
   ```

### 安全实现

1. **Token 黑名单管理**
   - 使用 Redis 存储黑名单（高性能）
   - 定期清理过期的黑名单记录
   - 实现黑名单查询优化

2. **并发登出处理**
   - 处理同一用户的多个会话
   - 实现全局登出功能
   - 处理设备间的登出同步

3. **安全清理**
   - 确保所有敏感数据被清除
   - 实现强制登出功能
   - 处理异常情况下的清理

### 中间件实现

1. **认证中间件更新**
   - 在认证中间件中检查 JWT 黑名单
   - 拒绝使用已失效的 token
   - 返回适当的错误响应

2. **请求拦截器**
   - 在请求拦截器中处理登出后的请求
   - 自动重定向到登录页
   - 清除过期的认证信息

### 基本测试步骤

1. **API 测试**
   - 测试正常登出流程
   - 测试无效 token 登出
   - 测试重复登出处理
   - 测试黑名单机制

2. **前端测试**
   - 登出按钮功能测试
   - 状态清理测试
   - 路由重定向测试
   - 用户体验测试

3. **安全测试**
   - Token 失效验证测试
   - 敏感数据清理测试
   - 会话管理测试
   - 并发登出测试

### 性能优化

1. **黑名单查询优化**
   - 使用 Redis 缓存黑名单
   - 实现黑名单索引优化
   - 定期清理过期记录

2. **缓存策略**
   - 优化用户状态缓存清理
   - 实现智能缓存失效
   - 减少不必要的数据库查询

### 监控和日志

1. **登出监控**
   - 监控登出操作频率
   - 监控登出操作成功率
   - 监控异常登出行为

2. **安全监控**
   - 监控 Token 黑名单使用情况
   - 监控会话清理状态
   - 监控异常登出模式



