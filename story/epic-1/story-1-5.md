# 用户故事 1-5：修改密码

## 故事描述

作为一名已登录用户，我希望能够在个人设置中修改我的登录密码，以提升账户安全性。

## 验收标准

- 用户可以在个人中心/设置页面修改密码
- 修改密码时需验证旧密码
- 新密码需符合基本安全要求
- 修改成功后，系统提示用户

## 业务价值

- 提升账户安全性
- 满足用户对安全的基本需求

---

## 技术实现建议（Tech Lead）

- 前端：使用 React Hook Form 提供修改密码表单，验证旧密码
- 后端： 校验旧密码，更新新密码
- 安全：基本的密码验证

## 技术难点

- 旧密码校验
- 新密码验证

## 测试建议

- 单元测试：密码校验、API 异常处理
- 集成测试：密码修改流程基本功能测试

---

## 详细实现步骤

### 前端实现步骤

1. **修改密码页面**
   - 创建 `app/settings/change-password/page.tsx`
   - 创建 `components/settings/change-password-form.tsx`
   - 使用 Shadcn UI 组件库设计界面

2. **表单设计**
   - 创建包含以下字段的表单：
     - 当前密码（必填）
     - 新密码（必填）
     - 确认新密码（必填）
   - 使用 React Hook Form 进行表单管理

3. **表单验证**
   - 验证当前密码不为空
   - 验证新密码基本要求：
     - 最小长度（6字符）
     - 不能与当前密码相同
   - 验证确认密码与新密码一致

4. **用户体验优化**
   - 添加密码可见性切换
   - 显示基本密码要求提示
   - 添加加载状态指示器
   - 实现基本的错误提示

5. **成功处理**
   - 显示修改成功提示
   - 清除表单数据

### 后端实现步骤

1. **修改密码 API**
   - 创建 `app/api/auth/change-password/route.ts`
   - 验证用户身份和权限
   - 处理密码修改请求

2. **旧密码验证**
   - 使用 Supabase Auth 验证当前密码
   - 实现基本的密码比对

3. **新密码验证**
   - 验证新密码基本要求
   - 检查密码长度

4. **密码更新**
   - 使用 Supabase Auth 更新密码
   - 更新数据库中的密码信息

5. **基本日志记录**
   - 记录密码修改事件
   - 记录修改时间

### 数据库设计（Prisma Schema）

1. **用户活动日志表**
   ```prisma
   model UserActivityLog {
     id           String   @id @default(cuid())
     userId       String
     activityType String   // 'login', 'logout', 'password_change'
     createdAt    DateTime @default(now())
     
     @@map("user_activity_logs")
   }
   ```

### 基本测试步骤

1. **API 测试**
   - 测试正常密码修改流程
   - 测试旧密码错误情况
   - 测试新密码不符合要求
   - 测试未授权访问

2. **前端测试**
   - 表单验证测试
   - 用户体验测试
   - 错误处理测试

